# ğŸ” RandevuBu Authentication System

**Enterprise-grade authentication using industry-standard security patterns**

---

## ğŸ—ï¸ Architecture Overview

Our authentication system follows the **exact same pattern** used by Auth0, Firebase, AWS Cognito, and major companies like GitHub, Netflix, and Airbnb.

### ğŸ”‘ **Core Components:**
- **Access Tokens**: Stored in memory (React state) - cleared on page refresh
- **Refresh Tokens**: Stored in HttpOnly cookies - secure from XSS attacks  
- **Session Hints**: Readable `hasAuth` cookie - prevents unnecessary API calls
- **Silent Refresh**: Automatic token renewal before expiry

---

## ğŸŒŠ Authentication Flow

### 1ï¸âƒ£ **Phone Verification Flow**

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant SMS

    User->>Frontend: Enter phone number
    Frontend->>Backend: POST /api/v1/auth/send-verification
    Backend->>SMS: Send verification code
    SMS->>User: Receive 6-digit code
    User->>Frontend: Enter verification code
    Frontend->>Backend: POST /api/v1/auth/verify-login
    Backend->>Frontend: Access token + Set cookies
    Frontend->>Frontend: Store access token in memory
    Frontend->>Backend: GET /api/v1/auth/profile (with token)
    Backend->>Frontend: User profile data
```

### 2ï¸âƒ£ **Login Success Response**

**Backend Response:**
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "user": {
      "id": "user-123",
      "phoneNumber": "+905551234567",
      "firstName": "John",
      "lastName": "Doe"
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIs...",
      "expiresIn": 3600
    },
    "isNewUser": false
  }
}
```

**Backend Sets Cookies:**
```javascript
// HttpOnly refresh token (secure, can't be read by JavaScript)
res.cookie('refreshToken', refreshToken, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict',
  path: '/api/v1/auth/refresh',
  maxAge: 7 * 24 * 60 * 60 * 1000 // 7 days
});

// Readable session hint (frontend can check this)
res.cookie('hasAuth', '1', {
  httpOnly: false,
  secure: true, 
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000 // 7 days
});
```

### 3ï¸âƒ£ **Frontend Token Management**

```typescript
// AuthContext.tsx - Login method
const login = async (phoneNumber: string, verificationCode: string) => {
  const response = await authService.verifyLogin({
    phoneNumber,
    verificationCode,
  });

  if (response.success && response.data) {
    const accessToken = response.data.tokens?.accessToken;
    
    // Store in memory + sync with API client immediately
    setAccessToken(accessToken);
    setApiAccessToken(accessToken);
    
    // Fetch user profile with guaranteed token
    const userProfile = await fetchUserProfile(accessToken);
    setUser(userProfile);
    
    return { success: true };
  }
};
```

---

## ğŸ”„ Token Refresh Flow

### **Silent Refresh (Industry Standard)**

```mermaid
sequenceDiagram
    participant App
    participant API
    participant Backend

    App->>App: Check hasAuth cookie exists?
    alt Cookie exists
        App->>API: POST /api/v1/auth/refresh (credentials: include)
        API->>Backend: HttpOnly cookie sent automatically
        Backend->>Backend: Validate refresh token
        Backend->>API: New access token + Update cookies
        API->>App: Store new access token in memory
        App->>App: Continue with authenticated session
    else No cookie
        App->>App: Skip refresh - user not logged in
        Note over App: Zero 400s on fresh visits!
    end
```

### **Automatic Refresh Implementation**

```typescript
// Set up automatic token refresh every 55 minutes
useEffect(() => {
  if (!accessToken) return;

  const refreshInterval = setInterval(async () => {
    await refreshToken(); // Silent refresh
  }, 55 * 60 * 1000); // 55 minutes

  return () => clearInterval(refreshInterval);
}, [accessToken]);
```

---

## ğŸš€ App Initialization Flow

### **Smart Session Restoration**

```typescript
// AuthContext.tsx - Initialization
useEffect(() => {
  const initializeAuth = async () => {
    try {
      // Only try refresh if hasAuth cookie exists
      if (hasAuthSession()) {
        const token = await refreshToken(true); // silent mode
        if (token) {
          const userProfile = await fetchUserProfile(token);
          setUser(userProfile);
        }
      }
      // No cookie = no API call = zero 400s âœ…
    } catch (error) {
      console.error('Failed to initialize auth:', error);
    } finally {
      setIsLoading(false);
    }
  };

  initializeAuth();
}, []);

// Cookie detection (same as GitHub, Auth0, etc.)
const hasAuthSession = (): boolean => {
  return document.cookie.includes('hasAuth=1');
};
```

---

## ğŸ”’ Security Features

### **XSS Protection**
- âœ… **Access tokens in memory only** - cleared on page refresh
- âœ… **Refresh tokens in HttpOnly cookies** - JavaScript cannot access
- âœ… **No localStorage/sessionStorage** - follows security best practices

### **CSRF Protection** 
- âœ… **sameSite: 'strict'** - cookies only sent to same origin
- âœ… **Secure cookies** - HTTPS only in production
- âœ… **Path restrictions** - refresh endpoint only

### **Token Rotation**
- âœ… **New refresh token on each use** - limits exposure window
- âœ… **Automatic cleanup on logout** - both cookies cleared
- âœ… **Graceful error handling** - invalid tokens handled silently

---

## ğŸ“± API Endpoints

### **Authentication Routes**
```javascript
POST   /api/v1/auth/send-verification    // Send SMS code
POST   /api/v1/auth/verify-login         // Verify code & login
POST   /api/v1/auth/refresh              // Refresh access token
POST   /api/v1/auth/logout               // Clear session
GET    /api/v1/auth/profile              // Get user profile
PATCH  /api/v1/auth/profile              // Update profile
POST   /api/v1/auth/change-phone         // Change phone number
DELETE /api/v1/auth/account              // Delete account
GET    /api/v1/auth/stats                // User statistics
```

### **Request Examples**

**Login Request:**
```javascript
POST /api/v1/auth/verify-login
Content-Type: application/json
{
  "phoneNumber": "+905551234567",
  "verificationCode": "123456"
}
```

**Refresh Request:**
```javascript
POST /api/v1/auth/refresh
Cookie: refreshToken=eyJhbGc...; hasAuth=1
Credentials: include

// No body needed - cookie sent automatically
```

**Protected Request:**
```javascript
GET /api/v1/auth/profile  
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

---

## ğŸŒ Frontend Implementation

### **React Context Structure**

```typescript
interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  accessToken: string | null;
  login: (phoneNumber: string, code: string) => Promise<{success: boolean}>;
  logout: () => Promise<void>;
  refreshUser: () => Promise<void>;
}
```

### **API Client Configuration**

```typescript
// api.ts - Axios setup
export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  withCredentials: true, // Send cookies automatically
  timeout: 10000,
});

// Request interceptor - Add Authorization header
apiClient.interceptors.request.use((config) => {
  if (currentAccessToken) {
    config.headers.Authorization = `Bearer ${currentAccessToken}`;
  }
  return config;
});
```

---

## ğŸ§ª Testing & Debugging

### **Debug Console Output**

```javascript
// Enhanced debug information shows auth state in detail:
ğŸ”‘ Auth Debug: {
  hasAccessToken: true,
  accessTokenLength: 147,
  isAuthenticated: true,
  shouldShowAuthUI: true,
  hasAuthCookie: true,
  hasInitialized: true,
  isLoading: false,
  userPhoneNumber: "+905551234567"
}
```

### **Browser DevTools Checks**

**Application Tab â†’ Cookies:**
- `hasAuth=1` (visible)
- `refreshToken` (HttpOnly - value hidden)

**Network Tab â†’ Login Response Headers:**
```
Set-Cookie: refreshToken=eyJhbG...; HttpOnly; Secure; SameSite=Strict; Path=/api/v1/auth/refresh
Set-Cookie: hasAuth=1; Secure; SameSite=Strict; Max-Age=604800
```

---

## ğŸš¦ Error Handling

### **Graceful Degradation**

```typescript
// No console spam for normal states
const refreshToken = async (silent = false) => {
  try {
    const response = await authService.refreshToken();
    // Handle success...
  } catch (error) {
    // Only log if not silent mode
    if (!silent) {
      console.error('Failed to refresh token:', error);
    }
    
    // Only clear auth state for unexpected errors
    const isTokenMissing = response.error?.code === 'REFRESH_TOKEN_MISSING';
    if (!isTokenMissing) {
      setAccessToken(null);
      setUser(null);
    }
  }
};
```

### **Network Error Recovery**

- **401 Unauthorized**: Automatic token refresh attempt
- **403 Forbidden**: Clear session and redirect to login
- **Network errors**: Retry with exponential backoff
- **Missing cookies**: Silent handling without errors

---

## ğŸ¯ Production Considerations

### **Environment Variables**
```env
NEXT_PUBLIC_API_URL=https://api.randevubu.com
NODE_ENV=production
```

### **Performance Optimizations**
- âœ… **Automatic token refresh** - 5 minutes before expiry
- âœ… **Smart initialization** - only refresh if session exists  
- âœ… **Minimal API calls** - prevents unnecessary 400s
- âœ… **Memory management** - tokens cleared on logout

### **Security Checklist**
- âœ… **HTTPS only** in production
- âœ… **Secure cookies** enabled
- âœ… **No sensitive data in localStorage**
- âœ… **CSRF protection** with sameSite
- âœ… **Token rotation** implemented
- âœ… **Audit logging** on backend

---

## ğŸŒŸ Why This Approach?

### **Industry Standard**
This exact pattern is used by:
- **GitHub**: `logged_in=yes` + HttpOnly session
- **Auth0**: Session hints + HttpOnly tokens  
- **Firebase**: `__session` + secure tokens
- **AWS Cognito**: Readable hints + HttpOnly refresh
- **Netflix**: `memclid` + `SecureNetflixId`

### **Benefits**
1. **ğŸ”’ Security**: XSS/CSRF protected, follows OWASP guidelines
2. **âš¡ Performance**: Zero unnecessary auth requests
3. **ğŸ“± UX**: Seamless session restoration
4. **ğŸ› ï¸ Developer Experience**: Clean network tab, no console spam
5. **ğŸ“ˆ Scalability**: Stateless tokens, horizontal scaling ready

### **Mobile Compatibility**
- **Web Apps**: Use cookies automatically
- **Mobile Apps**: Can still read tokens from response body
- **Universal**: Works across all platforms

---

## ğŸ”— Related Files

```
app/
â”œâ”€â”€ context/
â”‚   â””â”€â”€ AuthContext.tsx          // Main authentication logic + SSR handling
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api.ts                   // Axios configuration
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ auth.ts              // Authentication API calls
â”‚       â””â”€â”€ user.ts              // User profile API calls
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â””â”€â”€ PhoneAuth.tsx        // Login UI component
â”‚   â””â”€â”€ layout/
â”‚       â””â”€â”€ Navbar.tsx           // Auth-aware navigation
â””â”€â”€ types/
    â””â”€â”€ api.ts                   // TypeScript interfaces
middleware.ts                    // Server-side auth detection
```

## ğŸš€ New Features (Latest Update)

### **SSR/Hydration Improvements**
- âœ… **Perfect hydration**: No layout shift between server/client
- âœ… **Middleware integration**: Server-side auth state detection
- âœ… **Enhanced loading states**: Better UX during auth resolution
- âœ… **Graceful fallbacks**: Shows "YÃ¼kleniyor..." during auth loading

### **Enterprise-Level Stability**
- âœ… **Zero console spam**: Clean debug output
- âœ… **Bulletproof initialization**: Handles all edge cases
- âœ… **Race condition prevention**: Proper async handling
- âœ… **Mobile-first approach**: Works seamlessly on all devices

---

**ğŸ‰ Result: Enterprise-grade authentication system matching industry standards used by billion-dollar companies!**